<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Summer Movie Wager 2025</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .header h1 {
            font-size: 2.5em;
            color: #1e3c72;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
        }

        .tab {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: #ff6b6b;
            color: white;
            transform: translateY(-2px);
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .content {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            min-height: 500px;
        }

        .login-form, .signup-form {
            max-width: 400px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #ff6b6b;
        }

        button {
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .predictions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .prediction-slot {
            background: #f8f9fa;
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .prediction-slot.filled {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border: 2px solid #4facfe;
            color: white;
        }

        .prediction-slot:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .leaderboard {
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .leaderboard-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            font-weight: bold;
            text-align: center;
        }

        .player-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s ease;
        }

        .player-row:hover {
            background: #e9ecef;
        }

        .rank {
            font-size: 1.2em;
            font-weight: bold;
            width: 50px;
        }

        .rank.first { color: #ffd700; }
        .rank.second { color: #c0c0c0; }
        .rank.third { color: #cd7f32; }

        .player-name {
            flex: 1;
            font-weight: bold;
        }

        .points {
            font-size: 1.1em;
            font-weight: bold;
            color: #28a745;
        }

        .movies-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .movie-card {
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .movie-card:hover {
            border-color: #ff6b6b;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .movie-card.selected {
            background: #ff6b6b;
            border-color: #ff6b6b;
            color: white;
        }

        .dark-horses {
            background: #2d3436;
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .dark-horses-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .dark-horse-slot {
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .dark-horse-slot.filled {
            background: rgba(255, 107, 107, 0.3);
            border: 2px solid #ff6b6b;
            color: white;
        }

        .dark-horse-slot:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .hidden {
            display: none;
        }

        .welcome-message {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #a8edea, #fed6e3);
            border-radius: 10px;
        }

        .box-office-standings {
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .standings-header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            color: white;
            padding: 15px;
            font-weight: bold;
            text-align: center;
        }

        .movie-standing {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        .movie-standing:last-child {
            border-bottom: none;
        }

        .movie-rank {
            font-weight: bold;
            width: 30px;
        }

        .movie-title {
            flex: 1;
            margin-left: 10px;
        }

        .movie-earnings {
            font-weight: bold;
            color: #28a745;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé¨ Summer Movie Wager 2025 üèÜ</h1>
            <p>Predict the top 10 highest-grossing movies and compete with friends!</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('login')">Login</button>
            <button class="tab" onclick="showTab('signup')">Sign Up</button>
            <button class="tab hidden" onclick="showTab('predictions')">My Predictions</button>
            <button class="tab hidden" onclick="showTab('leaderboard')">Leaderboard</button>
            <button class="tab hidden" onclick="showTab('standings')">Box Office</button>
            <button class="tab hidden" onclick="showTab('admin')" id="admin-tab-btn" style="display: none;">Admin</button>
        </div>

        <div class="content">
            <!-- Login Tab -->
            <div id="login-tab">
                <div class="login-form">
                    <h2 style="text-align: center; margin-bottom: 30px;">Welcome Back!</h2>
                    <div class="form-group">
                        <label for="login-username">Username</label>
                        <input type="text" id="login-username" placeholder="Enter your username">
                    </div>
                    <div class="form-group">
                        <label for="login-password">Password</label>
                        <input type="password" id="login-password" placeholder="Enter your password">
                    </div>
                    <button onclick="login()">Login</button>
                </div>
            </div>

            <!-- Sign Up Tab -->
            <div id="signup-tab" class="hidden">
                <div class="signup-form">
                    <h2 style="text-align: center; margin-bottom: 30px;">Join the Wager!</h2>
                    <div class="form-group">
                        <label for="signup-username">Username</label>
                        <input type="text" id="signup-username" placeholder="Choose a username">
                    </div>
                    <div class="form-group">
                        <label for="signup-email">Email</label>
                        <input type="email" id="signup-email" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label for="signup-password">Password</label>
                        <input type="password" id="signup-password" placeholder="Create a password">
                    </div>
                    <button onclick="signup()">Sign Up</button>
                </div>
            </div>

            <!-- Predictions Tab -->
            <div id="predictions-tab" class="hidden">
                <div class="welcome-message">
                    <h2>Welcome, <span id="current-user"></span>! üéØ</h2>
                    <p>Drag movies to rank your top 10 predictions, then select 3 dark horses!</p>
                </div>

                <h3>üìä Rank Your Top 10 Movies</h3>
                <div class="predictions-grid" id="predictions-grid">
                    <!-- Prediction slots will be generated here -->
                </div>

                <h3>üé¨ Available Movies</h3>
                <div class="movies-list" id="movies-list">
                    <!-- Movie cards will be generated here -->
                </div>

                <div class="dark-horses">
                    <h3>üé≠ Dark Horses (Pick 3)</h3>
                    <p>Drag 3 movies here that you think will surprise everyone by making the top 10!</p>
                    <div class="dark-horses-grid" id="dark-horses-grid">
                        <!-- Dark horse slots will be generated here -->
                    </div>
                </div>

                <button onclick="savePredictions()" style="margin-top: 20px;">Save My Predictions</button>
            </div>

            <!-- Leaderboard Tab -->
            <div id="leaderboard-tab" class="hidden">
                <div class="leaderboard">
                    <div class="leaderboard-header">
                        <h2>üèÜ Player Rankings</h2>
                        <p style="margin-top: 10px; opacity: 0.9;">Updated after each box office change</p>
                    </div>
                    <div id="leaderboard-content">
                        <!-- Leaderboard will be populated here -->
                    </div>
                </div>
                
                <div style="margin-top: 20px; background: #f8f9fa; border-radius: 10px; padding: 20px;">
                    <h3 style="color: #333; margin-bottom: 15px;">üìä Scoring Breakdown</h3>
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="color: #ff6b6b; margin-bottom: 10px;">How Points Are Earned:</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 14px;">
                            <div>üéØ <strong>Exact match:</strong> 15 points</div>
                            <div>üìç <strong>1 spot off:</strong> 10 points</div>
                            <div>üìä <strong>2-3 spots off:</strong> 5 points</div>
                            <div>üêé <strong>Dark horse in top 10:</strong> 5 points</div>
                        </div>
                    </div>
                    <div id="detailed-breakdown">
                        <!-- Detailed breakdown will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Box Office Standings Tab -->
            <div id="standings-tab" class="hidden">
                <div class="box-office-standings">
                    <div class="standings-header">
                        <h2>üìà Summer 2025 Box Office Tracker</h2>
                        <p style="margin-top: 10px; opacity: 0.9;">All movies in our wager - Last updated: <span id="last-updated"></span></p>
                    </div>
                    <div id="standings-content">
                        <!-- Box office standings will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Admin Tab -->
            <div id="admin-tab" class="hidden">
                <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <h2>üîß Admin Panel</h2>
                    <p>Update box office standings manually or enable automatic updates</p>
                </div>
                
                <div style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <h3>üìä Super Quick Box Office Update</h3>
                    <p>Just paste the weekend box office data and I'll handle the rest!</p>
                    
                    <div style="margin: 15px 0; display: flex; gap: 10px; flex-wrap: wrap;">
                        <a href="https://www.boxofficemojo.com/weekend/" target="_blank" style="background: #007bff; color: white; padding: 10px 15px; border-radius: 5px; text-decoration: none; font-weight: bold;">üìà Box Office Mojo</a>
                        <a href="https://www.the-numbers.com/weekend-box-office-chart" target="_blank" style="background: #28a745; color: white; padding: 10px 15px; border-radius: 5px; text-decoration: none; font-weight: bold;">üìä The Numbers</a>
                        <button onclick="loadSmartUpdate()" style="background: #ff6b6b; color: white; padding: 10px 15px; border-radius: 5px; border: none; font-weight: bold; cursor: pointer;">‚ö° Smart Update</button>
                    </div>
                    
                    <div id="smart-update-form" style="display: none; margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h4>‚ö° Copy & Paste Method</h4>
                        <p style="color: #666; margin-bottom: 15px;">Copy the weekend box office list from any site and paste it here. I'll automatically extract the movies and rankings!</p>
                        
                        <label style="font-weight: bold; display: block; margin-bottom: 10px;">Paste Box Office Data Here:</label>
                        <textarea id="box-office-paste" placeholder="Example:
1. Superman - $45.2M
2. Lilo & Stitch - $32.1M  
3. How to Train Your Dragon - $28.5M
...or any format from box office sites" style="width: 100%; height: 150px; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-family: monospace;"></textarea>
                        
                        <div style="margin: 15px 0;">
                            <button onclick="parseBoxOfficeData()" style="background: #17a2b8; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin-right: 10px;">üîÑ Parse Data</button>
                            <button onclick="showQuickEdit()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px;">‚úèÔ∏è Manual Edit</button>
                        </div>
                        
                        <div id="parsed-preview" style="display: none; margin-top: 20px; padding: 15px; background: white; border-radius: 8px; border: 2px solid #28a745;">
                            <h5 style="color: #28a745; margin-bottom: 10px;">‚úÖ Parsed Successfully!</h5>
                            <div id="parsed-content"></div>
                            <button onclick="applyParsedData()" style="background: #28a745; color: white; padding: 12px 30px; border: none; border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 15px;">üíæ Apply These Rankings</button>
                        </div>
                    </div>
                    
                    <div id="quick-edit-form" style="display: none; margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h4>‚úèÔ∏è Quick Edit (Only Change What's Different)</h4>
                        <div id="quick-edit-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                            <!-- Quick edit fields will be generated here -->
                        </div>
                        <div style="margin-top: 20px; text-align: center;">
                            <button onclick="saveQuickEdit()" style="background: #28a745; color: white; padding: 12px 30px; border: none; border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer;">üíæ Update Rankings</button>
                        </div>
                    </div>
                </div>
                
                <div style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <h3>ü§ñ Auto-Update Settings</h3>
                    <p>Set up automatic TMDB data fetching (gets basic movie info, but not weekly rankings)</p>
                    <div style="margin: 15px 0;">
                        <button onclick="fetchLiveBoxOfficeData()" style="background: #17a2b8; margin-right: 10px;">Fetch TMDB Data</button>
                        <button onclick="enableAutoUpdates()" style="background: #28a745;">Enable 6-Hour Auto-Updates</button>
                    </div>
                </div>
                
                <div style="background: white; border-radius: 10px; padding: 20px;">
                    <h3>üìù Advanced Manual Updates</h3>
                    <p>For fine-tuned control over individual movies</p>
                    <button onclick="loadAdminPanel()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin-bottom: 15px;">Show Advanced Editor</button>
                    <div id="admin-rankings" style="display: none;">
                        <!-- Admin form will be populated here -->
                    </div>
                    <button onclick="saveBoxOfficeUpdate()" id="advanced-save-btn" style="margin-top: 20px; display: none;">Update Rankings & Recalculate Scores</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Live data integration
        const TMDB_API_KEY = '9dc9a6d3e191870d73fe63f94c1fb4ab';
        let autoUpdateEnabled = false;
        
        // Movie ID mapping for TMDB API (these are the actual TMDB movie IDs)
        const movieTMDBIds = {
            'Lilo & Stitch': 150540,
            'Thunderbolts': 567604,
            'Mission: Impossible - The Final Reckoning': 575264,
            'Final Destination: Bloodlines': 1034062,
            'Karate Kid: Legends': 1226578,
            'Ballerina: From the World of John Wick': 603692,
            'How to Train Your Dragon': 1160018,
            'Elio': 508883,
            'F1': 1073481,
            'Jurassic World Rebirth': 1226578,
            'Superman': 1726,
            'The Fantastic Four: First Steps': 617126,
            'Smurfs': 49026,
            '28 Years Later': 1034541,
            'Megan 2.0': 1226578,
            'The Naked Gun': 8012,
            'Freakier Friday': 1226578
        };

        // Box Office Mojo scraping (alternative to TMDB)
        async function fetchBoxOfficeMojoData() {
            console.log('Fetching Box Office Mojo data...');
            
            try {
                // We'll use a CORS proxy to access Box Office Mojo
                const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                const targetUrl = 'https://www.boxofficemojo.com/weekend/';
                
                console.log('Attempting to fetch from Box Office Mojo...');
                const response = await fetch(proxyUrl + targetUrl, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const html = await response.text();
                console.log('Got HTML response, parsing...');
                
                // Parse the HTML to extract box office data
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Find the weekend chart table
                const rows = doc.querySelectorAll('table tr');
                const boxOfficeData = [];
                
                for (let i = 1; i < Math.min(rows.length, 11); i++) { // Skip header, get top 10
                    const cells = rows[i].querySelectorAll('td');
                    if (cells.length >= 3) {
                        const rank = i;
                        const title = cells[1]?.textContent?.trim() || `Movie ${i}`;
                        const earnings = cells[2]?.textContent?.trim() || '$0';
                        
                        boxOfficeData.push({
                            rank: rank,
                            title: title,
                            earnings: earnings,
                            released: true
                        });
                    }
                }
                
                console.log('Parsed box office data:', boxOfficeData);
                
                if (boxOfficeData.length > 0) {
                    updateBoxOfficeData(boxOfficeData);
                    return true;
                } else {
                    throw new Error('No box office data found');
                }
                
            } catch (error) {
                console.error('Box Office Mojo scraping failed:', error);
                console.log('Falling back to TMDB data...');
                return await fetchLiveBoxOfficeData();
            }
        }

        // Enhanced live data fetching with Box Office Mojo priority
        async function fetchLiveBoxOfficeData() {
            console.log('Fetching live box office data from TMDB...');
            
            try {
                const movieData = [];
                
                // Fetch current data for each movie
                for (const [movieTitle, tmdbId] of Object.entries(movieTMDBIds)) {
                    try {
                        console.log(`Fetching data for ${movieTitle} (ID: ${tmdbId})`);
                        const response = await fetch(`https://api.themoviedb.org/3/movie/${tmdbId}?api_key=${TMDB_API_KEY}`);
                        
                        if (!response.ok) {
                            console.log(`API error for ${movieTitle}: ${response.status}`);
                            continue;
                        }
                        
                        const data = await response.json();
                        
                        // Only include movies with revenue data
                        if (data.revenue && data.revenue > 0) {
                            movieData.push({
                                title: movieTitle,
                                earnings: formatRevenue(data.revenue),
                                released: true,
                                revenue: data.revenue,
                                releaseDate: data.release_date
                            });
                        } else {
                            // Include unreleased movies too
                            movieData.push({
                                title: movieTitle,
                                earnings: data.release_date ? `Releases ${data.release_date}` : 'Release date TBA',
                                released: false,
                                revenue: 0,
                                releaseDate: data.release_date
                            });
                        }
                        
                        // Add small delay to avoid rate limiting
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                    } catch (error) {
                        console.log(`Error fetching data for ${movieTitle}:`, error);
                    }
                }
                
                // Sort by revenue (highest first)
                movieData.sort((a, b) => b.revenue - a.revenue);
                
                // Assign ranks and limit to top 10
                const newStandings = movieData.slice(0, 10).map((movie, index) => ({
                    rank: index + 1,
                    title: movie.title,
                    earnings: movie.earnings,
                    released: movie.released
                }));
                
                console.log('TMDB standings:', newStandings);
                
                // Update the app with new data
                updateBoxOfficeData(newStandings);
                return true;
                
            } catch (error) {
                console.error('Error fetching TMDB data:', error);
                return false;
            }
        }
        
        function formatRevenue(revenue) {
            if (revenue >= 1000000000) {
                return `$${(revenue / 1000000000).toFixed(1)}B`;
            } else if (revenue >= 1000000) {
                return `$${(revenue / 1000000).toFixed(1)}M`;
            } else {
                return `$${revenue.toLocaleString()}`;
            }
        }
        
        async function enableAutoUpdates() {
            autoUpdateEnabled = true;
            
            // Try Box Office Mojo first, fallback to TMDB
            console.log('Enabling auto-updates with Box Office Mojo priority...');
            const success = await fetchBoxOfficeMojoData();
            
            if (success) {
                // Set up automatic updates every 6 hours
                setInterval(async () => {
                    console.log('Running scheduled update...');
                    await fetchBoxOfficeMojoData();
                }, 6 * 60 * 60 * 1000);
                alert('Live data updates enabled! Box office numbers will refresh every 6 hours using Box Office Mojo data.');
            } else {
                alert('Could not enable live updates. Check console for details.');
            }
        }
        
        function disableAutoUpdates() {
            autoUpdateEnabled = false;
            alert('Auto-updates disabled. You can still manually update via the Admin panel.');
        }
        
        // Auto-fetch data when app loads
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('App initializing...');
            
            // Load existing data
            users = JSON.parse(localStorage.getItem('wager_users') || '{}');
            predictions = JSON.parse(localStorage.getItem('wager_predictions') || '{}');
            
            console.log('Loaded users:', Object.keys(users));
            console.log('Loaded predictions:', Object.keys(predictions));
            
            // Add demo data if none exists
            if (Object.keys(users).length === 0) {
                console.log('Creating demo data...');
                users = {
                    'Phil': { email: 'phil@example.com', password: 'password', points: 0 },
                    'Garrett': { email: 'garrett@example.com', password: 'password', points: 0 },
                    'Ryan': { email: 'ryan@example.com', password: 'password', points: 0 }
                };
                localStorage.setItem('wager_users', JSON.stringify(users));
                
                // FIXED: More realistic demo predictions
                predictions = {
                    'Phil': { 
                        top10: ['Lilo & Stitch', 'How to Train Your Dragon', 'Thunderbolts', 'Superman', 'The Fantastic Four: First Steps', 'Mission: Impossible - The Final Reckoning', 'Elio', 'Jurassic World Rebirth', 'Final Destination: Bloodlines', 'F1'],
                        darkHorses: ['Karate Kid: Legends', 'Megan 2.0', 'Ballerina: From the World of John Wick'],
                        points: 0
                    },
                    'Garrett': {
                        top10: ['How to Train Your Dragon', 'Lilo & Stitch', 'Superman', 'Thunderbolts', 'Mission: Impossible - The Final Reckoning', 'F1', 'Jurassic World Rebirth', 'Elio', 'The Fantastic Four: First Steps', 'Final Destination: Bloodlines'],
                        darkHorses: ['28 Years Later', 'Karate Kid: Legends', 'Freakier Friday'],
                        points: 0
                    },
                    'Ryan': {
                        top10: ['Superman', 'Lilo & Stitch', 'The Fantastic Four: First Steps', 'Thunderbolts', 'How to Train Your Dragon', 'Mission: Impossible - The Final Reckoning', 'Jurassic World Rebirth', 'Elio', 'F1', 'Final Destination: Bloodlines'],
                        darkHorses: ['28 Years Later', 'Megan 2.0', 'The Bad Guys 2'],
                        points: 0
                    }
                };
                localStorage.setItem('wager_predictions', JSON.stringify(predictions));
            }
            
            // Fetch live data on app load - try Box Office Mojo first
            console.log('Fetching live box office data...');
            let success = await fetchBoxOfficeMojoData();
            
            if (success) {
                console.log('Box Office Mojo data loaded successfully!');
            } else {
                console.log('Box Office Mojo failed, using TMDB fallback');
                success = await fetchLiveBoxOfficeData();
            }
            
            if (success) {
                // Calculate scores with real data
                updateAllUserScores();
            } else {
                console.log('All APIs failed, using demo data');
                // Calculate scores with demo data
                updateAllUserScores();
            }
            
            console.log('App initialization complete');
        });
        
        // FIXED: Initialize with fallback data, but fetch live data immediately
        let boxOfficeStandings = JSON.parse(localStorage.getItem('box_office_standings') || JSON.stringify([
            { rank: 1, title: 'Loading...', earnings: 'Fetching live data...', released: true },
            { rank: 2, title: 'Loading...', earnings: 'Fetching live data...', released: true },
            { rank: 3, title: 'Loading...', earnings: 'Fetching live data...', released: true },
            { rank: 4, title: 'Loading...', earnings: 'Fetching live data...', released: true },
            { rank: 5, title: 'Loading...', earnings: 'Fetching live data...', released: true },
            { rank: 6, title: 'Loading...', earnings: 'Fetching live data...', released: true },
            { rank: 7, title: 'Loading...', earnings: 'Fetching live data...', released: true },
            { rank: 8, title: 'Loading...', earnings: 'Fetching live data...', released: true },
            { rank: 9, title: 'Loading...', earnings: 'Fetching live data...', released: true },
            { rank: 10, title: 'Loading...', earnings: 'Fetching live data...', released: true }
        ]));

        // App state
        let currentUser = null;
        let users = JSON.parse(localStorage.getItem('wager_users') || '{}');
        let predictions = JSON.parse(localStorage.getItem('wager_predictions') || '{}');
        let selectedMovies = [];
        let darkHorses = [];

        // All summer movies being tracked
        const allSummerMovies = [
            { title: 'Lilo & Stitch', earnings: '$400.0M', released: true },
            { title: 'How to Train Your Dragon', earnings: '$224.0M', released: true },
            { title: 'Mission: Impossible - The Final Reckoning', earnings: '$166.3M', released: true },
            { title: 'Jurassic World Rebirth', earnings: '$147.3M', released: true },
            { title: 'Thunderbolts', earnings: '$127.7M', released: true },
            { title: 'F1', earnings: '$109.5M', released: true },
            { title: 'Final Destination: Bloodlines', earnings: '$65.1M', released: true },
            { title: '28 Years Later', earnings: '$50.1M', released: true },
            { title: 'Elio', earnings: '$42.2M', released: true },
            { title: 'Ballerina: From the World of John Wick', earnings: '$25.6M', released: true },
            { title: 'M3GAN 2.0', earnings: '$10.2M', released: true },
            { title: 'Karate Kid: Legends', earnings: '$8.5M', released: true },
            { title: 'Superman', earnings: 'July 11 release', released: false },
            { title: 'The Fantastic Four: First Steps', earnings: 'July 25 release', released: false },
            { title: 'Smurfs', earnings: 'July 18 release', released: false },
            { title: 'I Know What You Did Last Summer', earnings: 'July 18 release', released: false },
            { title: 'The Bad Guys 2', earnings: 'August 1 release', released: false },
            { title: 'The Naked Gun', earnings: 'August 1 release', released: false },
            { title: 'Freakier Friday', earnings: 'August 8 release', released: false },
            { title: 'Megan 2.0', earnings: '$10.2M', released: true }
        ];


        // Available movies for predictions
        const movies = [
            'Jurassic World Rebirth',
            'Lilo & Stitch', 
            'The Fantastic Four: First Steps',
            'How to Train Your Dragon',
            'Superman',
            'Mission: Impossible - The Final Reckoning',
            'Elio',
            'Thunderbolts',
            'F1',
            'Final Destination: Bloodlines',
            '28 Years Later',
            'Karate Kid: Legends',
            'The Bad Guys 2',
            'Ballerina: From the World of John Wick',
            'Freakier Friday',
            'Megan 2.0',
            'The Naked Gun',
            'Smurfs',
            'I Know What You Did Last Summer'
        ];

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('[id$="-tab"]').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            event.target.classList.add('active');

            // Update content based on tab
            if (tabName === 'predictions' && currentUser) {
                loadUserPredictions();
            } else if (tabName === 'leaderboard') {
                updateLeaderboard();
            } else if (tabName === 'standings') {
                updateBoxOfficeStandings();
            } else if (tabName === 'admin') {
                loadAdminPanel();
            }
        }

        function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            console.log('Login attempt:', username, password);
            console.log('Available users:', Object.keys(users));
            
            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }
            
            if (users[username] && users[username].password === password) {
                currentUser = username;
                document.getElementById('current-user').textContent = username;
                showUserTabs();
                showTab('predictions');
                initializePredictions();
                console.log('Login successful for:', username);
            } else {
                console.log('Login failed. User exists:', !!users[username]);
                if (users[username]) {
                    console.log('Password match:', users[username].password === password);
                }
                alert('Invalid username or password. Try: Phil, Garrett, or Ryan with password: password');
            }
        }

        function signup() {
            const username = document.getElementById('signup-username').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            
            if (!username || !email || !password) {
                alert('Please fill in all fields');
                return;
            }
            
            if (users[username]) {
                alert('Username already exists');
                return;
            }
            
            users[username] = { email, password, points: 0 };
            localStorage.setItem('wager_users', JSON.stringify(users));
            
            currentUser = username;
            document.getElementById('current-user').textContent = username;
            showUserTabs();
            showTab('predictions');
            initializePredictions();
        }

        function showUserTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('hidden');
            });
            
            // Show admin tab only for admin users
            if (currentUser === 'admin' || currentUser === 'Phil') {
                document.getElementById('admin-tab-btn').style.display = 'block';
            }
        }

        function initializePredictions() {
            createPredictionSlots();
            createDarkHorseSlots();
            createMovieCards();
        }

        function createPredictionSlots() {
            const grid = document.getElementById('predictions-grid');
            grid.innerHTML = '';
            
            for (let i = 1; i <= 10; i++) {
                const slot = document.createElement('div');
                slot.className = 'prediction-slot';
                slot.dataset.rank = i;
                slot.dataset.type = 'top10';
                slot.innerHTML = `
                    <h3>#${i}</h3>
                    <p>Drop a movie here</p>
                `;
                slot.ondrop = drop;
                slot.ondragover = allowDrop;
                slot.onclick = () => clearSlot(slot);
                grid.appendChild(slot);
            }
        }

        function createDarkHorseSlots() {
            const grid = document.getElementById('dark-horses-grid');
            grid.innerHTML = '';
            
            for (let i = 1; i <= 3; i++) {
                const slot = document.createElement('div');
                slot.className = 'dark-horse-slot';
                slot.dataset.rank = i;
                slot.dataset.type = 'darkhorse';
                slot.innerHTML = `
                    <h4>Dark Horse ${i}</h4>
                    <p>Drop a movie here</p>
                `;
                slot.ondrop = drop;
                slot.ondragover = allowDrop;
                slot.onclick = () => clearSlot(slot);
                grid.appendChild(slot);
            }
        }

        function createMovieCards() {
            const moviesList = document.getElementById('movies-list');
            moviesList.innerHTML = '';
            
            movies.forEach(movie => {
                const card = document.createElement('div');
                card.className = 'movie-card';
                card.draggable = true;
                card.textContent = movie;
                card.ondragstart = drag;
                moviesList.appendChild(card);
            });
        }

        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.textContent);
        }

        function drop(ev) {
            ev.preventDefault();
            const movie = ev.dataTransfer.getData("text");
            const slot = ev.currentTarget;
            const rank = parseInt(slot.dataset.rank);
            const type = slot.dataset.type;
            
            // Remove movie from its previous location if it exists
            removeMovieFromAllSlots(movie);
            
            if (type === 'top10') {
                slot.innerHTML = `
                    <h3>#${rank}</h3>
                    <p style="font-weight: bold; margin-top: 10px;">${movie}</p>
                    <small style="opacity: 0.7; margin-top: 5px;">Click to remove</small>
                `;
                slot.classList.add('filled');
                selectedMovies[rank - 1] = movie;
                
                // Remove from dark horses if it was there
                darkHorses = darkHorses.filter(m => m !== movie);
            } else if (type === 'darkhorse') {
                slot.innerHTML = `
                    <h4>Dark Horse ${rank}</h4>
                    <p style="font-weight: bold; margin-top: 10px;">${movie}</p>
                    <small style="opacity: 0.7; margin-top: 5px;">Click to remove</small>
                `;
                slot.classList.add('filled');
                darkHorses[rank - 1] = movie;
                
                // Remove from top 10 if it was there
                selectedMovies = selectedMovies.map(m => m === movie ? null : m);
            }
            
            // Clean up arrays
            darkHorses = darkHorses.filter(Boolean);
            updateMovieCardStates();
        }

        function clearSlot(slot) {
            if (!slot.classList.contains('filled')) return;
            
            const type = slot.dataset.type;
            const rank = parseInt(slot.dataset.rank);
            
            if (type === 'top10') {
                selectedMovies[rank - 1] = null;
                slot.innerHTML = `
                    <h3>#${rank}</h3>
                    <p>Drop a movie here</p>
                `;
                slot.classList.remove('filled');
            } else if (type === 'darkhorse') {
                darkHorses[rank - 1] = null;
                slot.innerHTML = `
                    <h4>Dark Horse ${rank}</h4>
                    <p>Drop a movie here</p>
                `;
                slot.classList.remove('filled');
            }
            
            // Clean up arrays
            darkHorses = darkHorses.filter(Boolean);
            updateMovieCardStates();
        }

        function removeMovieFromAllSlots(movie) {
            // Remove from top 10
            selectedMovies = selectedMovies.map(m => m === movie ? null : m);
            
            // Remove from dark horses
            darkHorses = darkHorses.filter(m => m !== movie);
            
            // Update UI
            document.querySelectorAll('.prediction-slot.filled').forEach(slot => {
                if (slot.textContent.includes(movie)) {
                    const rank = parseInt(slot.dataset.rank);
                    slot.innerHTML = `
                        <h3>#${rank}</h3>
                        <p>Drop a movie here</p>
                    `;
                    slot.classList.remove('filled');
                }
            });
            
            document.querySelectorAll('.dark-horse-slot.filled').forEach(slot => {
                if (slot.textContent.includes(movie)) {
                    const rank = parseInt(slot.dataset.rank);
                    slot.innerHTML = `
                        <h4>Dark Horse ${rank}</h4>
                        <p>Drop a movie here</p>
                    `;
                    slot.classList.remove('filled');
                }
            });
        }

        function updateMovieCardStates() {
            const usedMovies = [...selectedMovies.filter(Boolean), ...darkHorses];
            
            document.querySelectorAll('.movie-card').forEach(card => {
                if (usedMovies.includes(card.textContent)) {
                    card.style.opacity = '0.5';
                    card.style.background = '#e9ecef';
                } else {
                    card.style.opacity = '1';
                    card.style.background = '#f8f9fa';
                }
            });
        }

        // FIXED: Improved scoring calculation
        function calculatePoints(userPredictions) {
            if (!userPredictions) return 0;
            
            let totalPoints = 0;
            const top10 = userPredictions.top10 || [];
            const darkHorses = userPredictions.darkHorses || [];
            
            // Calculate points for top 10 predictions
            top10.forEach((predictedMovie, index) => {
                if (!predictedMovie) return;
                
                const predictedRank = index + 1; // 1-10
                const actualRank = findActualRank(predictedMovie);
                
                if (actualRank === -1) return; // Movie not in current top 10
                
                const difference = Math.abs(predictedRank - actualRank);
                
                if (difference === 0) {
                    // Exact position match
                    totalPoints += 15;
                } else if (difference === 1) {
                    // 1 spot off
                    totalPoints += 10;
                } else if (difference === 2 || difference === 3) {
                    // 2-3 spots off
                    totalPoints += 5;
                }
                // More than 3 spots off = 0 points
            });
            
            // Calculate points for dark horses
            darkHorses.forEach(darkHorse => {
                const actualRank = findActualRank(darkHorse);
                if (actualRank !== -1 && actualRank <= 10) {
                    // Dark horse made it to top 10
                    totalPoints += 5;
                }
            });
            
            return totalPoints;
        }
        
        // FIXED: Better movie matching logic
        function findActualRank(movieTitle) {
            // Find the current rank of a movie in box office standings
            const standing = boxOfficeStandings.find(s => {
                const standingTitle = s.title.toLowerCase().replace(/[^a-z0-9]/g, '');
                const predictedTitle = movieTitle.toLowerCase().replace(/[^a-z0-9]/g, '');
                
                return standingTitle.includes(predictedTitle) || 
                       predictedTitle.includes(standingTitle) ||
                       standingTitle === predictedTitle;
            });
            return standing ? standing.rank : -1;
        }
        
        function updateAllUserScores() {
            // Recalculate scores for all users based on current box office standings
            Object.keys(predictions).forEach(username => {
                const userPreds = predictions[username];
                userPreds.points = calculatePoints(userPreds);
            });
            
            // Update users object with new points
            Object.keys(predictions).forEach(username => {
                if (users[username]) {
                    users[username].points = predictions[username].points;
                }
            });
            
            localStorage.setItem('wager_predictions', JSON.stringify(predictions));
            localStorage.setItem('wager_users', JSON.stringify(users));
        }
        
        function updateBoxOfficeData(newStandings) {
            // This function would be called when new box office data comes in
            boxOfficeStandings = newStandings;
            localStorage.setItem('box_office_standings', JSON.stringify(boxOfficeStandings));
            
            // Update our complete tracking list with the new data
            updateAllSummerMoviesWithNewData(newStandings);
            
            // Recalculate all scores
            updateAllUserScores();
            
            // Refresh displays if user is logged in
            if (currentUser) {
                updateLeaderboard();
                updateBoxOfficeStandings();
            }
            
            console.log('Box office data updated! All scores recalculated.');
        }

        function updateAllSummerMoviesWithNewData(newStandings) {
            // Update our master list with new data
            newStandings.forEach(standing => {
                const movieIndex = allSummerMovies.findIndex(movie => 
                    movie.title.toLowerCase().includes(standing.title.toLowerCase()) ||
                    standing.title.toLowerCase().includes(movie.title.toLowerCase())
                );
                
                if (movieIndex !== -1) {
                    allSummerMovies[movieIndex] = {
                        ...allSummerMovies[movieIndex],
                        earnings: standing.earnings,
                        released: standing.released !== false,
                        rank: standing.rank
                    };
                }
            });
        }

        function savePredictions() {
            const filledTop10 = selectedMovies.filter(Boolean);
            const filledDarkHorses = darkHorses.filter(Boolean);
            
            if (filledTop10.length !== 10) {
                alert(`Please select all 10 movies for your top 10! You have ${filledTop10.length}/10 selected.`);
                return;
            }
            
            if (filledDarkHorses.length !== 3) {
                alert(`Please select exactly 3 dark horses! You have ${filledDarkHorses.length}/3 selected.`);
                return;
            }
            
            predictions[currentUser] = {
                top10: selectedMovies.slice(), // Create copy to avoid reference issues
                darkHorses: darkHorses.slice(),
                points: calculatePoints({ top10: selectedMovies, darkHorses: darkHorses })
            };
            
            // Update user points
            if (users[currentUser]) {
                users[currentUser].points = predictions[currentUser].points;
            }
            
            localStorage.setItem('wager_predictions', JSON.stringify(predictions));
            localStorage.setItem('wager_users', JSON.stringify(users));
            alert('Predictions saved successfully! Your current score: ' + predictions[currentUser].points + ' points');
        }

        function loadUserPredictions() {
            if (predictions[currentUser]) {
                const userPreds = predictions[currentUser];
                selectedMovies = (userPreds.top10 || []).slice(); // Create copy
                darkHorses = (userPreds.darkHorses || []).slice();
                
                // Update UI with saved predictions
                createPredictionSlots();
                createDarkHorseSlots();
                
                // Fill top 10 slots
                selectedMovies.forEach((movie, index) => {
                    if (movie) {
                        const slot = document.querySelector(`[data-rank="${index + 1}"][data-type="top10"]`);
                        if (slot) {
                            slot.innerHTML = `
                                <h3>#${index + 1}</h3>
                                <p style="font-weight: bold; margin-top: 10px;">${movie}</p>
                                <small style="opacity: 0.7; margin-top: 5px;">Click to remove</small>
                            `;
                            slot.classList.add('filled');
                        }
                    }
                });
                
                // Fill dark horse slots
                darkHorses.forEach((movie, index) => {
                    if (movie && index < 3) {
                        const slot = document.querySelector(`[data-rank="${index + 1}"][data-type="darkhorse"]`);
                        if (slot) {
                            slot.innerHTML = `
                                <h4>Dark Horse ${index + 1}</h4>
                                <p style="font-weight: bold; margin-top: 10px;">${movie}</p>
                                <small style="opacity: 0.7; margin-top: 5px;">Click to remove</small>
                            `;
                            slot.classList.add('filled');
                        }
                    }
                });
                
                createMovieCards();
                updateMovieCardStates();
            } else {
                // Reset everything for new user
                selectedMovies = [];
                darkHorses = [];
                createPredictionSlots();
                createDarkHorseSlots();
                createMovieCards();
            }
        }

        function updateLeaderboard() {
            const content = document.getElementById('leaderboard-content');
            const breakdown = document.getElementById('detailed-breakdown');
            
            // Store previous scores for comparison
            const currentScores = {};
            Object.entries(predictions).forEach(([username, data]) => {
                currentScores[username] = data.points || 0;
            });
            
            const sortedUsers = Object.entries(predictions)
                .map(([username, data]) => ({ 
                    username, 
                    points: data.points || 0,
                    previousPoints: previousScores[username] || 0,
                    change: (data.points || 0) - (previousScores[username] || 0)
                }))
                .sort((a, b) => b.points - a.points);
            
            content.innerHTML = sortedUsers.map((user, index) => {
                const rankClass = index === 0 ? 'first' : index === 1 ? 'second' : index === 2 ? 'third' : '';
                const rankEmoji = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                
                let changeIndicator = '';
                if (user.change > 0) {
                    changeIndicator = `<span style="color: #28a745; font-size: 0.9em;">+${user.change} ‚ÜóÔ∏è</span>`;
                } else if (user.change < 0) {
                    changeIndicator = `<span style="color: #dc3545; font-size: 0.9em;">${user.change} ‚ÜòÔ∏è</span>`;
                } else if (user.previousPoints > 0) {
                    changeIndicator = `<span style="color: #6c757d; font-size: 0.9em;">0 ‚û°Ô∏è</span>`;
                }
                
                return `
                    <div class="player-row">
                        <div class="rank ${rankClass}">${rankEmoji} ${index + 1}</div>
                        <div class="player-name">
                            ${user.username}
                            <div style="font-size: 0.8em; color: #666; margin-top: 2px;">${changeIndicator}</div>
                        </div>
                        <div class="points">${user.points} pts</div>
                    </div>
                `;
            }).join('');
            
            // Detailed breakdown for each player
            breakdown.innerHTML = `
                <h4 style="color: #333; margin-bottom: 15px;">üîç Player Performance Details</h4>
                ${sortedUsers.map(user => {
                    const userPreds = predictions[user.username];
                    if (!userPreds) return '';
                    
                    const breakdown = getDetailedBreakdown(userPreds);
                    return `
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ff6b6b;">
                            <h5 style="color: #333; margin-bottom: 10px;">${user.username} - ${user.points} points</h5>
                            <div style="font-size: 14px; color: #666;">
                                ${breakdown.exactMatches > 0 ? `üéØ ${breakdown.exactMatches} exact matches (${breakdown.exactMatches * 15} pts)<br>` : ''}
                                ${breakdown.oneOff > 0 ? `üìç ${breakdown.oneOff} one-spot-off (${breakdown.oneOff * 10} pts)<br>` : ''}
                                ${breakdown.twoThreeOff > 0 ? `üìä ${breakdown.twoThreeOff} 2-3 spots off (${breakdown.twoThreeOff * 5} pts)<br>` : ''}
                                ${breakdown.darkHorses > 0 ? `üêé ${breakdown.darkHorses} dark horses in top 10 (${breakdown.darkHorses * 5} pts)<br>` : ''}
                                ${breakdown.total === 0 ? 'No points earned yet' : ''}
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
            
            // Update previous scores for next comparison
            previousScores = currentScores;
            localStorage.setItem('previous_scores', JSON.stringify(previousScores));
        }

        function getDetailedBreakdown(userPredictions) {
            if (!userPredictions) return { exactMatches: 0, oneOff: 0, twoThreeOff: 0, darkHorses: 0, total: 0 };
            
            let exactMatches = 0, oneOff = 0, twoThreeOff = 0, darkHorses = 0;
            const top10 = userPredictions.top10 || [];
            const userDarkHorses = userPredictions.darkHorses || [];
            
            // Check top 10 predictions
            top10.forEach((predictedMovie, index) => {
                if (!predictedMovie) return;
                
                const predictedRank = index + 1;
                const actualRank = findActualRank(predictedMovie);
                
                if (actualRank === -1) return;
                
                const difference = Math.abs(predictedRank - actualRank);
                
                if (difference === 0) exactMatches++;
                else if (difference === 1) oneOff++;
                else if (difference === 2 || difference === 3) twoThreeOff++;
            });
            
            // Check dark horses
            userDarkHorses.forEach(darkHorse => {
                const actualRank = findActualRank(darkHorse);
                if (actualRank !== -1 && actualRank <= 10) {
                    darkHorses++;
                }
            });
            
            return { 
                exactMatches, 
                oneOff, 
                twoThreeOff, 
                darkHorses, 
                total: exactMatches * 15 + oneOff * 10 + twoThreeOff * 5 + darkHorses * 5 
            };
        }

        function updateBoxOfficeStandings() {
            const content = document.getElementById('standings-content');
            
            // Create a sorted list from our complete movie tracking
            const sortedMovies = [...allSummerMovies].sort((a, b) => {
                // Released movies first, sorted by earnings (extract number from earnings string)
                if (a.released && b.released) {
                    const aEarnings = parseFloat(a.earnings.replace(/[^0-9.]/g, '')) || 0;
                    const bEarnings = parseFloat(b.earnings.replace(/[^0-9.]/g, '')) || 0;
                    return bEarnings - aEarnings;
                } else if (a.released && !b.released) {
                    return -1; // Released movies come first
                } else if (!a.released && b.released) {
                    return 1;
                } else {
                    return 0; // Both unreleased, keep original order
                }
            });
            
            content.innerHTML = sortedMovies.map((movie, index) => {
                const isTop10 = movie.released && index < 10;
                const isReleased = movie.released;
                
                return `
                    <div class="movie-standing" style="
                        ${isTop10 ? 'background: linear-gradient(90deg, #fff2f2, #ffffff); border-left: 4px solid #ff6b6b;' : ''}
                        ${!isReleased ? 'background: #f8f9fa; opacity: 0.7;' : ''}
                        padding: 15px; margin-bottom: 2px;
                    ">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="font-weight: bold; min-width: 40px;">#${index + 1}</div>
                            ${isTop10 ? '<span style="background: #ff6b6b; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">TOP 10</span>' : ''}
                            ${!isReleased ? '<span style="background: #6c757d; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px;">UPCOMING</span>' : ''}
                        </div>
                        <div style="flex: 1; margin-left: 15px; font-weight: ${isTop10 ? 'bold' : 'normal'};">
                            ${movie.title}
                        </div>
                        <div style="font-weight: bold; color: ${isReleased ? '#28a745' : '#6c757d'}; min-width: 100px; text-align: right;">
                            ${movie.earnings}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Update last updated time
            const lastUpdated = document.getElementById('last-updated');
            if (lastUpdated) {
                lastUpdated.textContent = new Date().toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            }
        }
        
        let parsedBoxOfficeData = [];

        function loadSmartUpdate() {
            const form = document.getElementById('smart-update-form');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
            
            // Hide other forms
            document.getElementById('quick-edit-form').style.display = 'none';
            document.getElementById('parsed-preview').style.display = 'none';
        }

        function parseBoxOfficeData() {
            const pasteArea = document.getElementById('box-office-paste');
            const text = pasteArea.value.trim();
            
            if (!text) {
                alert('Please paste some box office data first!');
                return;
            }
            
            const lines = text.split('\n').filter(line => line.trim());
            parsedBoxOfficeData = [];
            
            lines.forEach((line, index) => {
                if (index >= 10) return; // Only top 10
                
                // Try to extract movie title and earnings from various formats
                let rank = index + 1;
                let title = '';
                let earnings = '';
                
                // Remove common prefixes (1., #1, 1), etc.)
                let cleanLine = line.replace(/^\s*[\d#]+[\.\)\-\s]*/, '').trim();
                
                // Look for dollar amounts
                const dollarMatch = cleanLine.match(/\$[\d,\.]+[MBK]?/i);
                if (dollarMatch) {
                    earnings = dollarMatch[0];
                    title = cleanLine.replace(dollarMatch[0], '').replace(/\s*[-‚Äì‚Äî]\s*$/, '').trim();
                } else {
                    // If no dollar amount, treat whole thing as title
                    title = cleanLine;
                    earnings = 'TBD';
                }
                
                // Clean up title (remove extra characters)
                title = title.replace(/[‚Äì‚Äî-]\s*$/, '').trim();
                
                if (title) {
                    parsedBoxOfficeData.push({
                        rank: rank,
                        title: title,
                        earnings: earnings,
                        released: earnings !== 'TBD' && earnings !== ''
                    });
                }
            });
            
            // Show preview
            const preview = document.getElementById('parsed-preview');
            const content = document.getElementById('parsed-content');
            
            if (parsedBoxOfficeData.length > 0) {
                content.innerHTML = parsedBoxOfficeData.map(movie => 
                    `<div style="margin: 5px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <strong>#${movie.rank}</strong> ${movie.title} - ${movie.earnings}
                    </div>`
                ).join('');
                preview.style.display = 'block';
            } else {
                alert('Could not parse any movie data. Try a different format or use manual edit.');
            }
        }

        function applyParsedData() {
            if (parsedBoxOfficeData.length === 0) {
                alert('No data to apply!');
                return;
            }
            
            updateBoxOfficeData(parsedBoxOfficeData);
            
            // Hide forms
            document.getElementById('smart-update-form').style.display = 'none';
            
            alert(`Updated ${parsedBoxOfficeData.length} movies! All scores recalculated.`);
            
            // Refresh displays
            if (currentUser) {
                updateLeaderboard();
                updateBoxOfficeStandings();
            }
        }

        function showQuickEdit() {
            document.getElementById('quick-edit-form').style.display = 'block';
            document.getElementById('parsed-preview').style.display = 'none';
            
            const grid = document.getElementById('quick-edit-grid');
            grid.innerHTML = '';
            
            boxOfficeStandings.forEach((movie, index) => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label style="font-weight: bold; display: block; margin-bottom: 5px;">#${index + 1}</label>
                    <input type="text" id="edit-title-${index}" value="${movie.title}" style="width: 100%; margin-bottom: 5px;" placeholder="Movie title">
                    <input type="text" id="edit-earnings-${index}" value="${movie.earnings}" style="width: 100%;" placeholder="Earnings">
                `;
                grid.appendChild(div);
            });
        }

        function saveQuickEdit() {
            const newStandings = [];
            
            for (let i = 0; i < 10; i++) {
                const titleInput = document.getElementById(`edit-title-${i}`);
                const earningsInput = document.getElementById(`edit-earnings-${i}`);
                
                if (titleInput && titleInput.value.trim()) {
                    newStandings.push({
                        rank: i + 1,
                        title: titleInput.value.trim(),
                        earnings: earningsInput ? earningsInput.value.trim() || 'TBD' : 'TBD',
                        released: earningsInput && !earningsInput.value.toLowerCase().includes('tbd') && earningsInput.value.trim() !== ''
                    });
                }
            }
            
            if (newStandings.length === 0) {
                alert('Please enter at least one movie!');
                return;
            }
            
            updateBoxOfficeData(newStandings);
            
            // Hide the form
            document.getElementById('smart-update-form').style.display = 'none';
            
            alert(`Updated ${newStandings.length} movies! All scores recalculated.`);
            
            // Refresh displays
            if (currentUser) {
                updateLeaderboard();
                updateBoxOfficeStandings();
            }
        }
        
        function loadAdminPanel() {
            const adminRankings = document.getElementById('admin-rankings');
            const saveBtn = document.getElementById('advanced-save-btn');
            
            if (adminRankings.style.display === 'none') {
                adminRankings.style.display = 'block';
                saveBtn.style.display = 'block';
                
                adminRankings.innerHTML = '';
                
                boxOfficeStandings.forEach((movie, index) => {
                    const div = document.createElement('div');
                    div.style.cssText = 'margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;';
                    div.innerHTML = `
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">#${index + 1} Movie:</label>
                        <select id="movie-${index}" style="width: 100%; margin-bottom: 10px;">
                            ${movies.map(m => `<option value="${m}" ${m === movie.title ? 'selected' : ''}>${m}</option>`).join('')}
                            <option value="${movie.title}" ${!movies.includes(movie.title) ? 'selected' : ''}>${movie.title}</option>
                        </select>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Earnings:</label>
                        <input type="text" id="earnings-${index}" value="${movie.earnings}" style="width: 100%;" placeholder="e.g., $150.2M or 'Not yet released'">
                    `;
                    adminRankings.appendChild(div);
                });
            } else {
                adminRankings.style.display = 'none';
                saveBtn.style.display = 'none';
            }
        }
        
        function saveBoxOfficeUpdate() {
            const newStandings = [];
            
            for (let i = 0; i < 10; i++) {
                const movieSelect = document.getElementById(`movie-${i}`);
                const earningsInput = document.getElementById(`earnings-${i}`);
                
                if (movieSelect && earningsInput) {
                    newStandings.push({
                        rank: i + 1,
                        title: movieSelect.value,
                        earnings: earningsInput.value,
                        released: !earningsInput.value.toLowerCase().includes('release') && !earningsInput.value.toLowerCase().includes('july') && !earningsInput.value.toLowerCase().includes('august')
                    });
                }
            }
            
            updateBoxOfficeData(newStandings);
            alert('Box office data updated! All player scores have been recalculated.');
            
            // Refresh the leaderboard to show new scores
            updateLeaderboard();
        }

        // FIXED: Initialize the app with realistic demo data
        document.addEventListener('DOMContentLoaded', function() {
            console.log('App initializing...');
            
            // Load existing data
            users = JSON.parse(localStorage.getItem('wager_users') || '{}');
            predictions = JSON.parse(localStorage.getItem('wager_predictions') || '{}');
            
            console.log('Loaded users:', Object.keys(users));
            console.log('Loaded predictions:', Object.keys(predictions));
            
            // Add demo data if none exists
            if (Object.keys(users).length === 0) {
                console.log('Creating demo data...');
                users = {
                    'Phil': { email: 'phil@example.com', password: 'password', points: 0 },
                    'Garrett': { email: 'garrett@example.com', password: 'password', points: 0 },
                    'Ryan': { email: 'ryan@example.com', password: 'password', points: 0 }
                };
                localStorage.setItem('wager_users', JSON.stringify(users));
                
                // FIXED: More realistic demo predictions
                predictions = {
                    'Phil': { 
                        top10: ['Lilo & Stitch', 'How to Train Your Dragon', 'Thunderbolts', 'Superman', 'The Fantastic Four: First Steps', 'Mission: Impossible - The Final Reckoning', 'Elio', 'Jurassic World Rebirth', 'Final Destination: Bloodlines', 'F1'],
                        darkHorses: ['Karate Kid: Legends', 'Megan 2.0', 'Ballerina: From the World of John Wick'],
                        points: 0
                    },
                    'Garrett': {
                        top10: ['How to Train Your Dragon', 'Lilo & Stitch', 'Superman', 'Thunderbolts', 'Mission: Impossible - The Final Reckoning', 'F1', 'Jurassic World Rebirth', 'Elio', 'The Fantastic Four: First Steps', 'Final Destination: Bloodlines'],
                        darkHorses: ['28 Years Later', 'Karate Kid: Legends', 'Freakier Friday'],
                        points: 0
                    },
                    'Ryan': {
                        top10: ['Superman', 'Lilo & Stitch', 'The Fantastic Four: First Steps', 'Thunderbolts', 'How to Train Your Dragon', 'Mission: Impossible - The Final Reckoning', 'Jurassic World Rebirth', 'Elio', 'F1', 'Final Destination: Bloodlines'],
                        darkHorses: ['28 Years Later', 'Megan 2.0', 'The Bad Guys 2'],
                        points: 0
                    }
                };
                localStorage.setItem('wager_predictions', JSON.stringify(predictions));
                
                // Calculate initial scores based on current box office standings
                updateAllUserScores();
                console.log('Demo data created and scores calculated');
                console.log('Final scores:', predictions);
            }
            
            console.log('App initialization complete');
        });
    </script>
</body>
</html>
